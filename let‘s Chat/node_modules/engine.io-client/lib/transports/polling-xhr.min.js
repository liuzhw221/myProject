var XMLHttpRequest=require("xmlhttprequest-ssl");var Polling=require("./polling");var Emitter=require("component-emitter");var inherit=require("component-inherit");var debug=require("debug")("engine.io-client:polling-xhr");module.exports=XHR;module.exports.Request=Request;function empty(){}function XHR(b){Polling.call(this,b);this.requestTimeout=b.requestTimeout;this.extraHeaders=b.extraHeaders;if(global.location){var c="https:"===location.protocol;var a=location.port;if(!a){a=c?443:80}this.xd=b.hostname!==global.location.hostname||a!==b.port;this.xs=b.secure!==c}}inherit(XHR,Polling);XHR.prototype.supportsBinary=true;XHR.prototype.request=function(a){a=a||{};a.uri=this.uri();a.xd=this.xd;a.xs=this.xs;a.agent=this.agent||false;a.supportsBinary=this.supportsBinary;a.enablesXDR=this.enablesXDR;a.pfx=this.pfx;a.key=this.key;a.passphrase=this.passphrase;a.cert=this.cert;a.ca=this.ca;a.ciphers=this.ciphers;a.rejectUnauthorized=this.rejectUnauthorized;a.requestTimeout=this.requestTimeout;a.extraHeaders=this.extraHeaders;return new Request(a)};XHR.prototype.doWrite=function(e,b){var d=typeof e!=="string"&&e!==undefined;var c=this.request({method:"POST",data:e,isBinary:d});var a=this;c.on("success",b);c.on("error",function(f){a.onError("xhr post error",f)});this.sendXhr=c};XHR.prototype.doPoll=function(){debug("xhr poll");var b=this.request();var a=this;b.on("data",function(c){a.onData(c)});b.on("error",function(c){a.onError("xhr poll error",c)});this.pollXhr=b};function Request(a){this.method=a.method||"GET";this.uri=a.uri;this.xd=!!a.xd;this.xs=!!a.xs;this.async=false!==a.async;this.data=undefined!==a.data?a.data:null;this.agent=a.agent;this.isBinary=a.isBinary;this.supportsBinary=a.supportsBinary;this.enablesXDR=a.enablesXDR;this.requestTimeout=a.requestTimeout;this.pfx=a.pfx;this.key=a.key;this.passphrase=a.passphrase;this.cert=a.cert;this.ca=a.ca;this.ciphers=a.ciphers;this.rejectUnauthorized=a.rejectUnauthorized;this.extraHeaders=a.extraHeaders;this.create()}Emitter(Request.prototype);Request.prototype.create=function(){var c={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};c.pfx=this.pfx;c.key=this.key;c.passphrase=this.passphrase;c.cert=this.cert;c.ca=this.ca;c.ciphers=this.ciphers;c.rejectUnauthorized=this.rejectUnauthorized;var f=this.xhr=new XMLHttpRequest(c);var a=this;try{debug("xhr open %s: %s",this.method,this.uri);f.open(this.method,this.uri,this.async);try{if(this.extraHeaders){f.setDisableHeaderCheck&&f.setDisableHeaderCheck(true);for(var b in this.extraHeaders){if(this.extraHeaders.hasOwnProperty(b)){f.setRequestHeader(b,this.extraHeaders[b])}}}}catch(d){}if("POST"===this.method){try{if(this.isBinary){f.setRequestHeader("Content-type","application/octet-stream")}else{f.setRequestHeader("Content-type","text/plain;charset=UTF-8")}}catch(d){}}try{f.setRequestHeader("Accept","*/*")}catch(d){}if("withCredentials" in f){f.withCredentials=true}if(this.requestTimeout){f.timeout=this.requestTimeout}if(this.hasXDR()){f.onload=function(){a.onLoad()};f.onerror=function(){a.onError(f.responseText)}}else{f.onreadystatechange=function(){if(f.readyState===2){var h;try{h=f.getResponseHeader("Content-Type")}catch(g){}if(h==="application/octet-stream"){f.responseType="arraybuffer"}}if(4!==f.readyState){return}if(200===f.status||1223===f.status){a.onLoad()}else{setTimeout(function(){a.onError(f.status)},0)}}}debug("xhr data %s",this.data);f.send(this.data)}catch(d){setTimeout(function(){a.onError(d)},0);return}if(global.document){this.index=Request.requestsCount++;Request.requests[this.index]=this}};Request.prototype.onSuccess=function(){this.emit("success");this.cleanup()};Request.prototype.onData=function(a){this.emit("data",a);this.onSuccess()};Request.prototype.onError=function(a){this.emit("error",a);this.cleanup(true)};Request.prototype.cleanup=function(a){if("undefined"===typeof this.xhr||null===this.xhr){return}if(this.hasXDR()){this.xhr.onload=this.xhr.onerror=empty}else{this.xhr.onreadystatechange=empty}if(a){try{this.xhr.abort()}catch(b){}}if(global.document){delete Request.requests[this.index]}this.xhr=null};Request.prototype.onLoad=function(){var a;try{var c;try{c=this.xhr.getResponseHeader("Content-Type")}catch(b){}if(c==="application/octet-stream"){a=this.xhr.response||this.xhr.responseText}else{a=this.xhr.responseText}}catch(b){this.onError(b)}if(null!=a){this.onData(a)}};Request.prototype.hasXDR=function(){return"undefined"!==typeof global.XDomainRequest&&!this.xs&&this.enablesXDR};Request.prototype.abort=function(){this.cleanup()};Request.requestsCount=0;Request.requests={};if(global.document){if(global.attachEvent){global.attachEvent("onunload",unloadHandler)}else{if(global.addEventListener){global.addEventListener("beforeunload",unloadHandler,false)}}}function unloadHandler(){for(var a in Request.requests){if(Request.requests.hasOwnProperty(a)){Request.requests[a].abort()}}};