var Polling=require("./polling");var inherit=require("component-inherit");module.exports=JSONPPolling;var rNewline=/\n/g;var rEscapedNewline=/\\n/g;var callbacks;function empty(){}function JSONPPolling(b){Polling.call(this,b);this.query=this.query||{};if(!callbacks){if(!global.___eio){global.___eio=[]}callbacks=global.___eio}this.index=callbacks.length;var a=this;callbacks.push(function(c){a.onData(c)});this.query.j=this.index;if(global.document&&global.addEventListener){global.addEventListener("beforeunload",function(){if(a.script){a.script.onerror=empty}},false)}}inherit(JSONPPolling,Polling);JSONPPolling.prototype.supportsBinary=false;JSONPPolling.prototype.doClose=function(){if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}if(this.form){this.form.parentNode.removeChild(this.form);this.form=null;this.iframe=null}Polling.prototype.doClose.call(this)};JSONPPolling.prototype.doPoll=function(){var b=this;var a=document.createElement("script");if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}a.async=true;a.src=this.uri();a.onerror=function(f){b.onError("jsonp poll error",f)};var d=document.getElementsByTagName("script")[0];if(d){d.parentNode.insertBefore(a,d)}else{(document.head||document.body).appendChild(a)}this.script=a;var c="undefined"!==typeof navigator&&/gecko/i.test(navigator.userAgent);if(c){setTimeout(function(){var e=document.createElement("iframe");document.body.appendChild(e);document.body.removeChild(e)},100)}};JSONPPolling.prototype.doWrite=function(h,j){var k=this;if(!this.form){var b=document.createElement("form");var c=document.createElement("textarea");var a=this.iframeId="eio_iframe_"+this.index;var g;b.className="socketio";b.style.position="absolute";b.style.top="-1000px";b.style.left="-1000px";b.target=a;b.method="POST";b.setAttribute("accept-charset","utf-8");c.name="d";b.appendChild(c);document.body.appendChild(b);this.form=b;this.area=c}this.form.action=this.uri();function d(){f();j()}function f(){if(k.iframe){try{k.form.removeChild(k.iframe)}catch(m){k.onError("jsonp polling iframe removal error",m)}}try{var l='<iframe src="javascript:0" name="'+k.iframeId+'">';g=document.createElement(l)}catch(m){g=document.createElement("iframe");g.name=k.iframeId;g.src="javascript:0"}g.id=k.iframeId;k.form.appendChild(g);k.iframe=g}f();h=h.replace(rEscapedNewline,"\\\n");this.area.value=h.replace(rNewline,"\\n");try{this.form.submit()}catch(i){}if(this.iframe.attachEvent){this.iframe.onreadystatechange=function(){if(k.iframe.readyState==="complete"){d()}}}else{this.iframe.onload=d}};