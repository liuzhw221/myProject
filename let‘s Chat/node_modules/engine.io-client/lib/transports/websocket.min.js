var Transport=require("../transport");var parser=require("engine.io-parser");var parseqs=require("parseqs");var inherit=require("component-inherit");var yeast=require("yeast");var debug=require("debug")("engine.io-client:websocket");var BrowserWebSocket=global.WebSocket||global.MozWebSocket;var NodeWebSocket;if(typeof window==="undefined"){try{NodeWebSocket=require("ws")}catch(e){}}var WebSocket=BrowserWebSocket;if(!WebSocket&&typeof window==="undefined"){WebSocket=NodeWebSocket}module.exports=WS;function WS(b){var a=(b&&b.forceBase64);if(a){this.supportsBinary=false}this.perMessageDeflate=b.perMessageDeflate;this.usingBrowserWebSocket=BrowserWebSocket&&!b.forceNode;this.protocols=b.protocols;if(!this.usingBrowserWebSocket){WebSocket=NodeWebSocket}Transport.call(this,b)}inherit(WS,Transport);WS.prototype.name="websocket";WS.prototype.supportsBinary=true;WS.prototype.doOpen=function(){if(!this.check()){return}var d=this.uri();var c=this.protocols;var b={agent:this.agent,perMessageDeflate:this.perMessageDeflate};b.pfx=this.pfx;b.key=this.key;b.passphrase=this.passphrase;b.cert=this.cert;b.ca=this.ca;b.ciphers=this.ciphers;b.rejectUnauthorized=this.rejectUnauthorized;if(this.extraHeaders){b.headers=this.extraHeaders}if(this.localAddress){b.localAddress=this.localAddress}try{this.ws=this.usingBrowserWebSocket?(c?new WebSocket(d,c):new WebSocket(d)):new WebSocket(d,c,b)}catch(a){return this.emit("error",a)}if(this.ws.binaryType===undefined){this.supportsBinary=false}if(this.ws.supports&&this.ws.supports.binary){this.supportsBinary=true;this.ws.binaryType="nodebuffer"}else{this.ws.binaryType="arraybuffer"}this.addEventListeners()};WS.prototype.addEventListeners=function(){var a=this;this.ws.onopen=function(){a.onOpen()};this.ws.onclose=function(){a.onClose()};this.ws.onmessage=function(b){a.onData(b.data)};this.ws.onerror=function(b){a.onError("websocket error",b)}};WS.prototype.write=function(g){var c=this;this.writable=false;var f=g.length;for(var d=0,b=f;d<b;d++){(function(h){parser.encodePacket(h,c.supportsBinary,function(k){if(!c.usingBrowserWebSocket){var j={};if(h.options){j.compress=h.options.compress}if(c.perMessageDeflate){var i="string"===typeof k?global.Buffer.byteLength(k):k.length;if(i<c.perMessageDeflate.threshold){j.compress=false}}}try{if(c.usingBrowserWebSocket){c.ws.send(k)}else{c.ws.send(k,j)}}catch(l){debug("websocket closed before onclose event")}--f||a()})})(g[d])}function a(){c.emit("flush");setTimeout(function(){c.writable=true;c.emit("drain")},0)}};WS.prototype.onClose=function(){Transport.prototype.onClose.call(this)};WS.prototype.doClose=function(){if(typeof this.ws!=="undefined"){this.ws.close()}};WS.prototype.uri=function(){var d=this.query||{};var c=this.secure?"wss":"ws";var b="";if(this.port&&(("wss"===c&&Number(this.port)!==443)||("ws"===c&&Number(this.port)!==80))){b=":"+this.port}if(this.timestampRequests){d[this.timestampParam]=yeast()}if(!this.supportsBinary){d.b64=1}d=parseqs.encode(d);if(d.length){d="?"+d}var a=this.hostname.indexOf(":")!==-1;return c+"://"+(a?"["+this.hostname+"]":this.hostname)+b+this.path+d};WS.prototype.check=function(){return !!WebSocket&&!("__initialize" in WebSocket&&this.name===WS.prototype.name)};