var Transport=require("../transport");var parseqs=require("parseqs");var parser=require("engine.io-parser");var inherit=require("component-inherit");var yeast=require("yeast");var debug=require("debug")("engine.io-client:polling");module.exports=Polling;var hasXHR2=(function(){var a=require("xmlhttprequest-ssl");var b=new a({xdomain:false});return null!=b.responseType})();function Polling(b){var a=(b&&b.forceBase64);if(!hasXHR2||a){this.supportsBinary=false}Transport.call(this,b)}inherit(Polling,Transport);Polling.prototype.name="polling";Polling.prototype.doOpen=function(){this.poll()};Polling.prototype.pause=function(a){var b=this;this.readyState="pausing";function d(){debug("paused");b.readyState="paused";a()}if(this.polling||!this.writable){var c=0;if(this.polling){debug("we are currently polling - waiting to pause");c++;this.once("pollComplete",function(){debug("pre-pause polling complete");--c||d()})}if(!this.writable){debug("we are currently writing - waiting to pause");c++;this.once("drain",function(){debug("pre-pause writing complete");--c||d()})}}else{d()}};Polling.prototype.poll=function(){debug("polling");this.polling=true;this.doPoll();this.emit("poll")};Polling.prototype.onData=function(b){var a=this;debug("polling got data %s",b);var c=function(f,d,e){if("opening"===a.readyState){a.onOpen()}if("close"===f.type){a.onClose();return false}a.onPacket(f)};parser.decodePayload(b,this.socket.binaryType,c);if("closed"!==this.readyState){this.polling=false;this.emit("pollComplete");if("open"===this.readyState){this.poll()}else{debug('ignoring poll - transport state "%s"',this.readyState)}}};Polling.prototype.doClose=function(){var a=this;function b(){debug("writing close packet");a.write([{type:"close"}])}if("open"===this.readyState){debug("transport open - closing");b()}else{debug("transport not open - deferring close");this.once("open",b)}};Polling.prototype.write=function(c){var b=this;this.writable=false;var a=function(){b.writable=true;b.emit("drain")};parser.encodePayload(c,this.supportsBinary,function(d){b.doWrite(d,a)})};Polling.prototype.uri=function(){var d=this.query||{};var c=this.secure?"https":"http";var b="";if(false!==this.timestampRequests){d[this.timestampParam]=yeast()}if(!this.supportsBinary&&!d.sid){d.b64=1}d=parseqs.encode(d);if(this.port&&(("https"===c&&Number(this.port)!==443)||("http"===c&&Number(this.port)!==80))){b=":"+this.port}if(d.length){d="?"+d}var a=this.hostname.indexOf(":")!==-1;return c+"://"+(a?"["+this.hostname+"]":this.hostname)+b+this.path+d};