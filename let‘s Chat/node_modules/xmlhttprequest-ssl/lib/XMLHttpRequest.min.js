var fs=require("fs");var Url=require("url");var spawn=require("child_process").spawn;module.exports=XMLHttpRequest;XMLHttpRequest.XMLHttpRequest=XMLHttpRequest;function XMLHttpRequest(k){var l=this;var p=require("http");var h=require("https");var f;var a;var r={};var g=false;var q={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"};var d=q;var o=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"];var j=["TRACE","TRACK","CONNECT"];var e=false;var c=false;var m={};this.UNSENT=0;this.OPENED=1;this.HEADERS_RECEIVED=2;this.LOADING=3;this.DONE=4;this.readyState=this.UNSENT;this.onreadystatechange=null;this.responseText="";this.responseXML="";this.status=null;this.statusText=null;var b=function(s){return g||(s&&o.indexOf(s.toLowerCase())===-1)};var i=function(s){return(s&&j.indexOf(s)===-1)};this.open=function(w,u,v,s,t){this.abort();c=false;if(!i(w)){throw"SecurityError: Request method not allowed"}r={method:w,url:u.toString(),async:(typeof v!=="boolean"?true:v),user:s||null,password:t||null};n(this.OPENED)};this.setDisableHeaderCheck=function(s){g=s};this.setRequestHeader=function(t,s){if(this.readyState!=this.OPENED){throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";return false}if(!b(t)){console.warn('Refused to set unsafe header "'+t+'"');return false}if(e){throw"INVALID_STATE_ERR: send flag is true";return false}d[t]=s;return true};this.getResponseHeader=function(s){if(typeof s==="string"&&this.readyState>this.OPENED&&a.headers[s.toLowerCase()]&&!c){return a.headers[s.toLowerCase()]}return null};this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||c){return""}var s="";for(var t in a.headers){if(t!=="set-cookie"&&t!=="set-cookie2"){s+=t+": "+a.headers[t]+"\r\n"}}return s.substr(0,s.length-2)};this.getRequestHeader=function(s){if(typeof s==="string"&&d[s]){return d[s]}return""};this.send=function(L){if(this.readyState!=this.OPENED){throw"INVALID_STATE_ERR: connection must be opened before send() is called"}if(e){throw"INVALID_STATE_ERR: send has already been called"}var C=false,G=false;var v=Url.parse(r.url);var F;switch(v.protocol){case"https:":C=true;case"http:":F=v.hostname;break;case"file:":G=true;break;case undefined:case"":F="localhost";break;default:throw"Protocol not supported."}if(G){if(r.method!=="GET"){throw"XMLHttpRequest: Only GET method is supported"}if(r.async){fs.readFile(v.pathname,"utf8",function(M,N){if(M){l.handleError(M)}else{l.status=200;l.responseText=N;n(l.DONE)}})}else{try{this.responseText=fs.readFileSync(v.pathname,"utf8");this.status=200;n(l.DONE)}catch(I){this.handleError(I)}}return}var B=v.port||(C?443:80);var w=v.pathname+(v.search?v.search:"");d.Host=F;if(!((C&&B===443)||B===80)){d.Host+=":"+v.port}if(r.user){if(typeof r.password=="undefined"){r.password=""}var A=new Buffer(r.user+":"+r.password);d.Authorization="Basic "+A.toString("base64")}if(r.method==="GET"||r.method==="HEAD"){L=null}else{if(L){d["Content-Length"]=Buffer.isBuffer(L)?L.length:Buffer.byteLength(L);if(!d["Content-Type"]){d["Content-Type"]="text/plain;charset=UTF-8"}}else{if(r.method==="POST"){d["Content-Length"]=0}}}var s=false;if(k&&k.agent){s=k.agent}var u={host:F,port:B,path:w,method:r.method,headers:d,agent:s};if(C){u.pfx=k.pfx;u.key=k.key;u.passphrase=k.passphrase;u.cert=k.cert;u.ca=k.ca;u.ciphers=k.ciphers;u.rejectUnauthorized=k.rejectUnauthorized}c=false;if(r.async){var H=C?h.request:p.request;e=true;l.dispatchEvent("readystatechange");var t=function(O){a=O;if(a.statusCode===302||a.statusCode===303||a.statusCode===307){r.url=a.headers.location;var M=Url.parse(r.url);F=M.hostname;var N={hostname:M.hostname,port:M.port,path:M.path,method:a.statusCode===303?"GET":r.method,headers:d};if(C){N.pfx=k.pfx;N.key=k.key;N.passphrase=k.passphrase;N.cert=k.cert;N.ca=k.ca;N.ciphers=k.ciphers;N.rejectUnauthorized=k.rejectUnauthorized}f=H(N,t).on("error",x);f.end();return}if(a&&a.setEncoding){a.setEncoding("utf8")}n(l.HEADERS_RECEIVED);l.status=a.statusCode;a.on("data",function(P){if(P){l.responseText+=P}if(e){n(l.LOADING)}});a.on("end",function(){if(e){n(l.DONE);e=false}});a.on("error",function(P){l.handleError(P)})};var x=function(M){l.handleError(M)};f=H(u,t).on("error",x);if(L){f.write(L)}f.end();l.dispatchEvent("loadstart")}else{var D=".node-xmlhttprequest-content-"+process.pid;var y=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(y,"","utf8");var E="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(C?"s":"")+".request;var options = "+JSON.stringify(u)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {  responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+D+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');fs.unlinkSync('"+y+"');});response.on('error', function(error) {fs.writeFileSync('"+D+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');fs.unlinkSync('"+y+"');});}).on('error', function(error) {fs.writeFileSync('"+D+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');fs.unlinkSync('"+y+"');});"+(L?"req.write('"+L.replace(/'/g,"\\'")+"');":"")+"req.end();";var K=spawn(process.argv[0],["-e",E]);var J;while(fs.existsSync(y)){}l.responseText=fs.readFileSync(D,"utf8");K.stdin.end();fs.unlinkSync(D);if(l.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)){var z=l.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,"");l.handleError(z)}else{l.status=l.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1");l.responseText=l.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1");n(l.DONE)}}};this.handleError=function(s){this.status=503;this.statusText=s;this.responseText=s.stack;c=true;n(this.DONE)};this.abort=function(){if(f){f.abort();f=null}d=q;this.responseText="";this.responseXML="";c=true;if(this.readyState!==this.UNSENT&&(this.readyState!==this.OPENED||e)&&this.readyState!==this.DONE){e=false;n(this.DONE)}this.readyState=this.UNSENT};this.addEventListener=function(s,t){if(!(s in m)){m[s]=[]}m[s].push(t)};this.removeEventListener=function(s,t){if(s in m){m[s]=m[s].filter(function(u){return u!==t})}};this.dispatchEvent=function(u){if(typeof l["on"+u]==="function"){l["on"+u]()}if(u in m){for(var t=0,s=m[u].length;t<s;t++){m[u][t].call(l)}}};var n=function(s){if(l.readyState!==s){l.readyState=s;if(r.async||l.readyState<l.OPENED||l.readyState===l.DONE){l.dispatchEvent("readystatechange")}if(l.readyState===l.DONE&&!c){l.dispatchEvent("load");l.dispatchEvent("loadend")}}}};