var http=require("http");var read=require("fs").readFileSync;var path=require("path");var exists=require("fs").existsSync;var engine=require("engine.io");var client=require("socket.io-client");var clientVersion=require("socket.io-client/package").version;var Client=require("./client");var Emitter=require("events").EventEmitter;var Namespace=require("./namespace");var Adapter=require("socket.io-adapter");var parser=require("socket.io-parser");var debug=require("debug")("socket.io:server");var url=require("url");module.exports=Server;var clientSource=undefined;var clientSourceMap=undefined;function Server(a,b){if(!(this instanceof Server)){return new Server(a,b)}if("object"==typeof a&&a instanceof Object&&!a.listen){b=a;a=null}b=b||{};this.nsps={};this.path(b.path||"/socket.io");this.serveClient(false!==b.serveClient);this.parser=b.parser||parser;this.encoder=new this.parser.Encoder();this.adapter(b.adapter||Adapter);this.origins(b.origins||"*:*");this.sockets=this.of("/");if(a){this.attach(a,b)}}Server.prototype.checkRequest=function(e,d){var a=e.headers.origin||e.headers.referer;if("null"==a||null==a){a="*"}if(!!a&&typeof(this._origins)=="function"){return this._origins(a,d)}if(this._origins.indexOf("*:*")!==-1){return d(null,true)}if(a){try{var g=url.parse(a);var f="https:"==g.protocol?443:80;g.port=g.port!=null?g.port:f;var c=~this._origins.indexOf(g.hostname+":"+g.port)||~this._origins.indexOf(g.hostname+":*")||~this._origins.indexOf("*:"+g.port);return d(null,!!c)}catch(b){}}d(null,false)};Server.prototype.serveClient=function(a){if(!arguments.length){return this._serveClient}this._serveClient=a;var c=function(d){var e=path.resolve(__dirname,"./../../",d);if(exists(e)){return e}return require.resolve(d)};if(a&&!clientSource){clientSource=read(c("socket.io-client/dist/socket.io.js"),"utf-8");try{clientSourceMap=read(c("socket.io-client/dist/socket.io.js.map"),"utf-8")}catch(b){debug("could not load sourcemap file")}}return this};var oldSettings={transports:"transports","heartbeat timeout":"pingTimeout","heartbeat interval":"pingInterval","destroy buffer size":"maxHttpBufferSize"};Server.prototype.set=function(a,b){if("authorization"==a&&b){this.use(function(c,d){b(c.request,function(f,e){if(f){return d(new Error(f))}if(!e){return d(new Error("Not authorized"))}d()})})}else{if("origins"==a&&b){this.origins(b)}else{if("resource"==a){this.path(b)}else{if(oldSettings[a]&&this.eio[oldSettings[a]]){this.eio[oldSettings[a]]=b}else{console.error("Option %s is not valid. Please refer to the README.",a)}}}}return this};Server.prototype.path=function(a){if(!arguments.length){return this._path}this._path=a.replace(/\/$/,"");return this};Server.prototype.adapter=function(a){if(!arguments.length){return this._adapter}this._adapter=a;for(var b in this.nsps){if(this.nsps.hasOwnProperty(b)){this.nsps[b].initAdapter()}}return this};Server.prototype.origins=function(a){if(!arguments.length){return this._origins}this._origins=a;return this};Server.prototype.listen=Server.prototype.attach=function(a,e){if("function"==typeof a){var f="You are trying to attach socket.io to an express request handler function. Please pass a http.Server instance.";throw new Error(f)}if(Number(a)==a){a=Number(a)}if("number"==typeof a){debug("creating http server and binding to %d",a);var c=a;a=http.Server(function(h,g){g.writeHead(404);g.end()});a.listen(c)}e=e||{};e.path=e.path||this.path();e.allowRequest=e.allowRequest||this.checkRequest.bind(this);var b=this;var d={type:parser.CONNECT,nsp:"/"};this.encoder.encode(d,function(g){e.initialPacket=g;debug("creating engine.io instance with opts %j",e);b.eio=engine.attach(a,e);if(b._serveClient){b.attachServe(a)}b.httpServer=a;b.bind(b.eio)});return this};Server.prototype.attachServe=function(a){debug("attaching client serving req handler");var d=this._path+"/socket.io.js";var e=this._path+"/socket.io.js.map";var c=a.listeners("request").slice(0);var b=this;a.removeAllListeners("request");a.on("request",function(h,g){if(0===h.url.indexOf(e)){b.serveMap(h,g)}else{if(0===h.url.indexOf(d)){b.serve(h,g)}else{for(var f=0;f<c.length;f++){c[f].call(a,h,g)}}}})};Server.prototype.serve=function(d,b){var a='"'+clientVersion+'"';var c=d.headers["if-none-match"];if(c){if(a==c){debug("serve client 304");b.writeHead(304);b.end();return}}debug("serve client source");b.setHeader("Content-Type","application/javascript");b.setHeader("ETag",a);b.writeHead(200);b.end(clientSource)};Server.prototype.serveMap=function(d,b){var a='"'+clientVersion+'"';var c=d.headers["if-none-match"];if(c){if(a==c){debug("serve client 304");b.writeHead(304);b.end();return}}debug("serve client sourcemap");b.setHeader("Content-Type","application/json");b.setHeader("ETag",a);b.writeHead(200);b.end(clientSourceMap)};Server.prototype.bind=function(a){this.engine=a;this.engine.on("connection",this.onconnection.bind(this));return this};Server.prototype.onconnection=function(b){debug("incoming connection with id %s",b.id);var a=new Client(this,b);a.connect("/");return this};Server.prototype.of=function(a,b){if(String(a)[0]!=="/"){a="/"+a}var c=this.nsps[a];if(!c){debug("initializing namespace %s",a);c=new Namespace(this,a);this.nsps[a]=c}if(b){c.on("connect",b)}return c};Server.prototype.close=function(a){for(var b in this.nsps["/"].sockets){if(this.nsps["/"].sockets.hasOwnProperty(b)){this.nsps["/"].sockets[b].onclose()}}this.engine.close();if(this.httpServer){this.httpServer.close(a)}else{a&&a()}};var emitterMethods=Object.keys(Emitter.prototype).filter(function(a){return typeof Emitter.prototype[a]==="function"});emitterMethods.concat(["to","in","use","send","write","clients","compress"]).forEach(function(a){Server.prototype[a]=function(){return this.sockets[a].apply(this.sockets,arguments)}});Namespace.flags.forEach(function(a){Object.defineProperty(Server.prototype,a,{get:function(){this.sockets.flags=this.sockets.flags||{};this.sockets.flags[a]=true;return this}})});Server.listen=Server;