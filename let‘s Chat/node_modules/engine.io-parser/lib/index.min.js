var utf8=require("./utf8");var hasBinary=require("has-binary2");var after=require("after");var keys=require("./keys");exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6};var packetslist=keys(packets);var err={type:"error",data:"parser error"};exports.encodePacket=function(b,e,c,d){if(typeof e==="function"){d=e;e=null}if(typeof c==="function"){d=c;c=null}if(Buffer.isBuffer(b.data)){return encodeBuffer(b,e,d)}else{if(b.data&&(b.data.buffer||b.data) instanceof ArrayBuffer){b.data=arrayBufferToBuffer(b.data);return encodeBuffer(b,e,d)}}var a=packets[b.type];if(undefined!==b.data){a+=c?utf8.encode(String(b.data),{strict:false}):String(b.data)}return d(""+a)};function encodeBuffer(c,e,d){if(!e){return exports.encodeBase64Packet(c,d)}var b=c.data;var a=new Buffer(1);a[0]=packets[c.type];return d(Buffer.concat([a,b]))}exports.encodeBase64Packet=function(b,c){if(!Buffer.isBuffer(b.data)){b.data=arrayBufferToBuffer(b.data)}var a="b"+packets[b.type];a+=b.data.toString("base64");return c(a)};exports.decodePacket=function(c,e,a){if(c===undefined){return err}var b;if(typeof c==="string"){b=c.charAt(0);if(b==="b"){return exports.decodeBase64Packet(c.substr(1),e)}if(a){c=tryDecode(c);if(c===false){return err}}if(Number(b)!=b||!packetslist[b]){return err}if(c.length>1){return{type:packetslist[b],data:c.substring(1)}}else{return{type:packetslist[b]}}}if(e==="arraybuffer"){var d=new Uint8Array(c);b=d[0];return{type:packetslist[b],data:d.buffer.slice(1)}}if(c instanceof ArrayBuffer){c=arrayBufferToBuffer(c)}b=c[0];return{type:packetslist[b],data:c.slice(1)}};function tryDecode(a){try{a=utf8.decode(a,{strict:false})}catch(b){return false}return a}exports.decodeBase64Packet=function(e,f){var b=packetslist[e.charAt(0)];var c=new Buffer(e.substr(1),"base64");if(f==="arraybuffer"){var d=new Uint8Array(c.length);for(var a=0;a<d.length;a++){d[a]=c[a]}c=d.buffer}return{type:b,data:c}};exports.encodePayload=function(b,d,c){if(typeof d==="function"){c=d;d=null}if(d&&hasBinary(b)){return exports.encodePayloadAsBinary(b,c)}if(!b.length){return c("0:")}function a(f,e){exports.encodePacket(f,d,false,function(g){e(null,setLengthHeader(g))})}map(b,a,function(f,e){return c(e.join(""))})};function setLengthHeader(a){return a.length+":"+a}function map(d,f,b){var a=new Array(d.length);var e=after(d.length,b);for(var c=0;c<d.length;c++){f(d[c],function(g,h){a[c]=h;e(g,a)})}}exports.decodePayload=function(h,a,m){if(typeof h!=="string"){return exports.decodePayloadAsBinary(h,a,m)}if(typeof a==="function"){m=a;a=null}if(h===""){return m(err,0,1)}var c="",d,e,b;for(var j=0,f=h.length;j<f;j++){var g=h.charAt(j);if(g!==":"){c+=g;continue}if(c===""||(c!=(d=Number(c)))){return m(err,0,1)}e=h.substr(j+1,d);if(c!=e.length){return m(err,0,1)}if(e.length){b=exports.decodePacket(e,a,false);if(err.type===b.type&&err.data===b.data){return m(err,0,1)}var k=m(b,j+d,f);if(false===k){return}}j+=d;c=""}if(c!==""){return m(err,0,1)}};function bufferToString(b){var d="";for(var c=0,a=b.length;c<a;c++){d+=String.fromCharCode(b[c])}return d}function stringToBuffer(c){var b=new Buffer(c.length);for(var d=0,a=c.length;d<a;d++){b.writeUInt8(c.charCodeAt(d),d)}return b}function arrayBufferToBuffer(d){var f=new Uint8Array(d.buffer||d);var c=d.byteLength||d.length;var e=d.byteOffset||0;var a=new Buffer(c);for(var b=0;b<c;b++){a[b]=f[e+b]}return a}exports.encodePayloadAsBinary=function(a,b){if(!a.length){return b(new Buffer(0))}map(a,encodeOneBinaryPacket,function(d,c){return b(Buffer.concat(c))})};function encodeOneBinaryPacket(c,a){function b(g){var e=""+g.length;var f;if(typeof g==="string"){f=new Buffer(e.length+2);f[0]=0;for(var d=0;d<e.length;d++){f[d+1]=parseInt(e[d],10)}f[f.length-1]=255;return a(null,Buffer.concat([f,stringToBuffer(g)]))}f=new Buffer(e.length+2);f[0]=1;for(var d=0;d<e.length;d++){f[d+1]=parseInt(e[d],10)}f[f.length-1]=255;a(null,Buffer.concat([f,g]))}exports.encodePacket(c,true,true,b)}exports.decodePayloadAsBinary=function(f,a,l){if(typeof a==="function"){l=a;a=null}var k=f;var m=[];var g;while(k.length>0){var b="";var c=k[0]===0;for(g=1;;g++){if(k[g]===255){break}if(b.length>310){return l(err,0,1)}b+=""+k[g]}k=k.slice(b.length+1);var j=parseInt(b,10);var d=k.slice(1,j+1);if(c){d=bufferToString(d)}m.push(d);k=k.slice(j+1)}var h=m.length;for(g=0;g<h;g++){var e=m[g];l(exports.decodePacket(e,a,true),g,h)}};