var Transport=require("../transport");var parser=require("engine.io-parser");var util=require("util");var debug=require("debug")("engine:ws");module.exports=WebSocket;function WebSocket(b){Transport.call(this,b);var a=this;this.socket=b.websocket;this.socket.on("message",this.onData.bind(this));this.socket.once("close",this.onClose.bind(this));this.socket.on("error",this.onError.bind(this));this.socket.on("headers",c);this.writable=true;this.perMessageDeflate=null;function c(d){a.emit("headers",d)}}util.inherits(WebSocket,Transport);WebSocket.prototype.name="websocket";WebSocket.prototype.handlesUpgrades=true;WebSocket.prototype.supportsFraming=true;WebSocket.prototype.onData=function(a){debug('received "%s"',a);Transport.prototype.onData.call(this,a)};WebSocket.prototype.send=function(f){var a=this;for(var c=0;c<f.length;c++){var e=f[c];parser.encodePacket(e,a.supportsBinary,d)}function d(i){debug('writing "%s"',i);var h={};if(e.options){h.compress=e.options.compress}if(a.perMessageDeflate){var g="string"===typeof i?Buffer.byteLength(i):i.length;if(g<a.perMessageDeflate.threshold){h.compress=false}}a.writable=false;a.socket.send(i,h,b)}function b(g){if(g){return a.onError("write error",g.stack)}a.writable=true;a.emit("drain")}};WebSocket.prototype.doClose=function(a){debug("closing");this.socket.close();a&&a()};