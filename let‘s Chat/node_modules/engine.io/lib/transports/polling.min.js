var Transport=require("../transport");var parser=require("engine.io-parser");var zlib=require("zlib");var accepts=require("accepts");var util=require("util");var debug=require("debug")("engine:polling");var compressionMethods={gzip:zlib.createGzip,deflate:zlib.createDeflate};module.exports=Polling;function Polling(a){Transport.call(this,a);this.closeTimeout=30*1000;this.maxHttpBufferSize=null;this.httpCompression=null}util.inherits(Polling,Transport);Polling.prototype.name="polling";Polling.prototype.onRequest=function(b){var a=b.res;if("GET"===b.method){this.onPollRequest(b,a)}else{if("POST"===b.method){this.onDataRequest(b,a)}else{a.writeHead(500);a.end()}}};Polling.prototype.onPollRequest=function(e,c){if(this.req){debug("request overlap");this.onError("overlap from client");c.writeHead(500);c.end();return}debug("setting request");this.req=e;this.res=c;var b=this;function a(){b.onError("poll connection closed prematurely")}function d(){e.removeListener("close",a);b.req=b.res=null}e.cleanup=d;e.on("close",a);this.writable=true;this.emit("drain");if(this.writable&&this.shouldClose){debug("triggering empty send to append close packet");this.send([{type:"noop"}])}};Polling.prototype.onDataRequest=function(g,f){if(this.dataReq){this.onError("data request overlap from client");f.writeHead(500);f.end();return}var b="application/octet-stream"===g.headers["content-type"];this.dataReq=g;this.dataRes=f;var e=b?new Buffer(0):"";var i=this;function c(){e=b?new Buffer(0):"";g.removeListener("data",d);g.removeListener("end",a);g.removeListener("close",h);i.dataReq=i.dataRes=null}function h(){c();i.onError("data request connection closed prematurely")}function d(k){var j;if(typeof k==="string"){e+=k;j=Buffer.byteLength(e)}else{e=Buffer.concat([e,k]);j=e.length}if(j>i.maxHttpBufferSize){e="";g.connection.destroy()}}function a(){i.onData(e);var j={"Content-Type":"text/html","Content-Length":2};f.writeHead(200,i.headers(g,j));f.end("ok");c()}g.on("close",h);if(!b){g.setEncoding("utf8")}g.on("data",d);g.on("end",a)};Polling.prototype.onData=function(b){debug('received "%s"',b);var a=this;var c=function(d){if("close"===d.type){debug("got xhr close packet");a.onClose();return false}a.onPacket(d)};parser.decodePayload(b,c)};Polling.prototype.onClose=function(){if(this.writable){this.send([{type:"noop"}])}Transport.prototype.onClose.call(this)};Polling.prototype.send=function(b){this.writable=false;if(this.shouldClose){debug("appending close packet to payload");b.push({type:"close"});this.shouldClose();this.shouldClose=null}var a=this;parser.encodePayload(b,this.supportsBinary,function(d){var c=b.some(function(e){return e.options&&e.options.compress});a.write(d,{compress:c})})};Polling.prototype.write=function(c,b){debug('writing "%s"',c);var a=this;this.doWrite(c,b,function(){a.req.cleanup()})};Polling.prototype.doWrite=function(e,j,h){var i=this;var b=typeof e==="string";var g=b?"text/plain; charset=UTF-8":"application/octet-stream";var d={"Content-Type":g};if(!this.httpCompression||!j.compress){a(e);return}var f=b?Buffer.byteLength(e):e.length;if(f<this.httpCompression.threshold){a(e);return}var c=accepts(this.req).encodings(["gzip","deflate"]);if(!c){a(e);return}this.compress(e,c,function(k,l){if(k){i.res.writeHead(500);i.res.end();h(k);return}d["Content-Encoding"]=c;a(l)});function a(k){d["Content-Length"]="string"===typeof k?Buffer.byteLength(k):k.length;i.res.writeHead(200,i.headers(i.req,d));i.res.end(k);h()}};Polling.prototype.compress=function(d,b,e){debug("compressing");var a=[];var c=0;compressionMethods[b](this.httpCompression).on("error",e).on("data",function(f){a.push(f);c+=f.length}).on("end",function(){e(null,Buffer.concat(a,c))}).end(d)};Polling.prototype.doClose=function(c){debug("closing");var b=this;var d;if(this.dataReq){debug("aborting ongoing data request");this.dataReq.destroy()}if(this.writable){debug("transport writable - closing right away");this.send([{type:"close"}]);a()}else{if(this.discarded){debug("transport discarded - closing right away");a()}else{debug("transport not writable - buffering orderly close");this.shouldClose=a;d=setTimeout(a,this.closeTimeout)}}function a(){clearTimeout(d);c();b.onClose()}};Polling.prototype.headers=function(b,c){c=c||{};var a=b.headers["user-agent"];if(a&&(~a.indexOf(";MSIE")||~a.indexOf("Trident/"))){c["X-XSS-Protection"]="0"}this.emit("headers",c);return c};