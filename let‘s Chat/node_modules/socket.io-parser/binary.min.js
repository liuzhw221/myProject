var isArray=require("isarray");var isBuf=require("./is-buffer");var toString=Object.prototype.toString;var withNativeBlob=typeof global.Blob==="function"||toString.call(global.Blob)==="[object BlobConstructor]";var withNativeFile=typeof global.File==="function"||toString.call(global.File)==="[object FileConstructor]";exports.deconstructPacket=function(d){var b=[];var a=d.data;var c=d;c.data=_deconstructPacket(a,b);c.attachments=b.length;return{packet:c,buffers:b}};function _deconstructPacket(e,a){if(!e){return e}if(isBuf(e)){var f={_placeholder:true,num:a.length};a.push(e);return f}else{if(isArray(e)){var d=new Array(e.length);for(var c=0;c<e.length;c++){d[c]=_deconstructPacket(e[c],a)}return d}else{if(typeof e==="object"&&!(e instanceof Date)){var d={};for(var b in e){d[b]=_deconstructPacket(e[b],a)}return d}}}return e}exports.reconstructPacket=function(b,a){b.data=_reconstructPacket(b.data,a);b.attachments=undefined;return b};function _reconstructPacket(d,a){if(!d){return d}if(d&&d._placeholder){return a[d.num]}else{if(isArray(d)){for(var c=0;c<d.length;c++){d[c]=_reconstructPacket(d[c],a)}}else{if(typeof d==="object"){for(var b in d){d[b]=_reconstructPacket(d[b],a)}}}}return d}exports.removeBlobs=function(c,e){function d(k,l,g){if(!k){return k}if((withNativeBlob&&k instanceof Blob)||(withNativeFile&&k instanceof File)){a++;var f=new FileReader();f.onload=function(){if(g){g[l]=this.result}else{b=this.result}if(!--a){e(b)}};f.readAsArrayBuffer(k)}else{if(isArray(k)){for(var j=0;j<k.length;j++){d(k[j],j,k)}}else{if(typeof k==="object"&&!isBuf(k)){for(var h in k){d(k[h],h,k)}}}}}var a=0;var b=c;d(b);if(!a){e(b)}};